# Convex Backend

This folder contains the Convex backend functions for the elcokiin project.

## Folder Structure

```
convex/
├── _lib/                   # Shared utilities (not exported to API)
│   └── auth.ts             # Auth helpers: requireAuth, requireAdmin, isAdmin, etc.
│
├── documents/              # Documents feature
│   ├── queries.ts          # Document query functions (public API)
│   ├── mutations.ts        # Document mutation functions (public API)
│   ├── projections.ts      # Data projection helpers (toDocumentListItem, etc.)
│   ├── helpers.ts          # General document helpers (getByIdForAuthor)
│   ├── slug_helpers.ts     # Slug management (slugExists, redirects)
│   └── stats_helpers.ts    # Document statistics (O(1) counts)
│
├── authors/                # Authors feature
│   ├── queries.ts          # Author query functions
│   ├── mutations.ts        # Author mutation functions
│   ├── helpers.ts          # Author helpers
│   └── projections.ts      # Author data projections
│
├── storage.ts              # Storage mutations (generateUploadUrl, getUrl, deleteFile)
│
├── _generated/             # Auto-generated by Convex (do not edit)
├── auth.ts                 # Better-Auth setup and getCurrentUser query
├── auth.config.ts          # Better-Auth configuration
├── convex.config.ts        # Convex configuration
├── healthCheck.ts          # Health check endpoint
├── http.ts                 # HTTP router for webhooks
└── schema.ts               # Database schema definitions
```

## Architecture

### Feature-Based Organization

- **documents/** - Document feature with queries, mutations, and helpers
- **authors/** - Author feature with queries and mutations
- **storage.ts** - Simple storage mutations (no helpers needed)
- **_lib/** - Shared internal utilities

### Helpers Strategy

Helpers are organized by concern within each feature folder:

| File | Location | Purpose |
|------|----------|---------|
| `helpers.ts` | `documents/` | General helpers (`getByIdForAuthor`) |
| `slug_helpers.ts` | `documents/` | Slug validation and redirects |
| `stats_helpers.ts` | `documents/` | O(1) document count statistics |
| `projections.ts` | `documents/` | Data projections for API responses |

Single-use logic is inlined directly into query/mutation handlers.

### Shared Utilities

The `_lib/` folder contains shared utilities used across features:

- **auth.ts** - Authentication helpers: `requireAuth`, `requireAdmin`, `isAdmin`, `getCurrentUser`

The underscore prefix (`_lib`) tells Convex not to export these as API endpoints.

## Usage

### Frontend API Calls

```typescript
import { api } from "@elcokiin/backend/convex/_generated/api";

// Document Queries
const documents = useQuery(api.documents.queries.list);
const stats = useQuery(api.documents.queries.getAdminStats);

// Document Mutations
const createDocument = useMutation(api.documents.mutations.create);
const updateTitle = useMutation(api.documents.mutations.updateTitle);

// Storage Mutations
const uploadUrl = useMutation(api.storage.generateUploadUrl);
const getUrl = useMutation(api.storage.getUrl);
```

### Backend Helper Usage

```typescript
// In mutations.ts - using helpers from different files
import * as Auth from "../_lib/auth";
import { getByIdForAuthor } from "./helpers";
import { slugExists, addSlugRedirect } from "./slug_helpers";
import { incrementStatusCount, updateStatusCount } from "./stats_helpers";

export const updateTitle = mutation({
  args: { documentId: v.id("documents"), title: v.string() },
  handler: async (ctx, args) => {
    const document = await getByIdForAuthor(ctx, args.documentId);
    
    // Generate new slug if needed
    const slug = await generateUniqueSlug(args.title, args.documentId, 
      async (s) => await slugExists(ctx, s, args.documentId)
    );
    
    await ctx.db.patch(args.documentId, { title: args.title, slug });
  },
});

// Inlined logic when helper isn't needed
export const create = mutation({
  args: { title: v.string(), type: documentTypeValidator },
  handler: async (ctx, args) => {
    const userId = await Auth.requireAuth(ctx);
    const documentId = await ctx.db.insert("documents", {
      title: args.title,
      type: args.type,
      status: "building",
      authorId: userId,
      createdAt: Date.now(),
      updatedAt: Date.now(),
    });
    
    // Update stats
    await incrementStatusCount(ctx, "building");
    
    return documentId;
  },
});
```

## Guidelines

1. **Inline single-use logic** directly into handlers
2. **Create helpers only** when logic is used by 2+ functions
3. **Organize helpers by concern** (slug_helpers, stats_helpers, etc.)
4. **Shared auth helpers** go in `_lib/auth.ts`
5. Always use `withIndex()` instead of `.filter()` for database queries
6. Always validate authentication in protected functions using `_lib/auth.ts`

See `.ruler/convex.md` for detailed coding guidelines.
