# Convex Backend

This folder contains the Convex backend functions for the elcokiin project.

## Folder Structure

```
convex/
├── _lib/                   # Shared utilities (not exported to API)
│   └── auth.ts             # Auth helpers: requireAuth, requireAdmin, isAdmin, etc.
│
├── documents/              # Documents feature
│   ├── queries.ts          # Document query functions (public API)
│   ├── mutations.ts        # Document mutation functions (public API)
│   └── helpers.ts          # Shared document helpers (getByIdForAuthor, updateMetadata)
│
├── storage.ts              # Storage mutations (generateUploadUrl, getUrl, deleteFile)
│
├── _generated/             # Auto-generated by Convex (do not edit)
├── auth.ts                 # Better-Auth setup and getCurrentUser query
├── auth.config.ts          # Better-Auth configuration
├── convex.config.ts        # Convex configuration
├── healthCheck.ts          # Health check endpoint
├── http.ts                 # HTTP router for webhooks
└── schema.ts               # Database schema definitions
```

## Architecture

### Feature-Based Organization

- **documents/** - Document feature with queries and mutations
- **storage.ts** - Simple storage mutations (no helpers needed)
- **_lib/** - Shared internal utilities

### Helpers Strategy

Helpers are only created when logic is genuinely reused:

| Helper | Location | Used By |
|--------|----------|---------|
| `getByIdForAuthor` | `documents/helpers.ts` | 7 mutations (edit, publish, submit, etc.) |
| `updateMetadata` | `documents/helpers.ts` | 2 mutations (updateTitle, updateMetadata) |

Single-use logic is inlined directly into query/mutation handlers.

### Shared Utilities

The `_lib/` folder contains shared utilities used across features:

- **auth.ts** - Authentication helpers: `requireAuth`, `requireAdmin`, `isAdmin`, `getCurrentUser`

The underscore prefix (`_lib`) tells Convex not to export these as API endpoints.

## Usage

### Frontend API Calls

```typescript
import { api } from "@elcokiin/backend/convex/_generated/api";

// Document Queries
const documents = useQuery(api.documents.queries.list);
const stats = useQuery(api.documents.queries.getAdminStats);

// Document Mutations
const createDocument = useMutation(api.documents.mutations.create);
const updateTitle = useMutation(api.documents.mutations.updateTitle);

// Storage Mutations
const uploadUrl = useMutation(api.storage.generateUploadUrl);
const getUrl = useMutation(api.storage.getUrl);
```

### Backend Helper Usage

```typescript
// In mutations.ts - using shared helpers
import * as Auth from "../_lib/auth";
import { getByIdForAuthor, updateMetadata } from "./helpers";

export const updateTitle = mutation({
  args: { documentId: v.id("documents"), title: v.string() },
  handler: async (ctx, args) => {
    await updateMetadata(ctx, args.documentId, { title: args.title });
  },
});

// Inlined logic when helper isn't needed
export const create = mutation({
  args: { title: v.string(), type: documentTypeValidator },
  handler: async (ctx, args) => {
    const userId = await Auth.requireAuth(ctx);
    return await ctx.db.insert("documents", {
      title: args.title,
      type: args.type,
      status: "building",
      authorId: userId,
      createdAt: Date.now(),
      updatedAt: Date.now(),
    });
  },
});
```

## Guidelines

1. **Inline single-use logic** directly into handlers
2. **Create helpers only** when logic is used by 2+ functions
3. **Shared auth helpers** go in `_lib/auth.ts`
4. Always use `withIndex()` instead of `.filter()` for database queries
5. Always validate authentication in protected functions using `_lib/auth.ts`

See `.ruler/convex-backend.md` for detailed coding guidelines.
